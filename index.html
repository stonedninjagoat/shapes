<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CSV Column Grouping & Sorting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #column-checkboxes, #sort-instructions { margin: 10px 0; }
  label { margin-right: 10px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; }
  table, th, td { border: 1px solid black; padding: 5px; text-align: left; }
  .sort-indicator { font-size: 8px; color: gray; margin-left: 2px; }
  th.sortable { cursor: pointer; text-decoration: underline; }
</style>
</head>
<body>

<h2>data</h2>
<input type="file" id="csvFile" accept=".csv" />
<div id="column-checkboxes"></div>
<div id="sort-instructions"></div>
<table id="csvTable"></table>

<script>
let originalData = [];
let headers = [];
let sortPriority = []; // [{col: 'columnName', dir: 'asc'|'desc'}]

const csvFileInput = document.getElementById('csvFile');
const checkboxesDiv = document.getElementById('column-checkboxes');
const sortInstructionsDiv = document.getElementById('sort-instructions');
const csvTable = document.getElementById('csvTable');

// Upload CSV
csvFileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      originalData = results.data;
      headers = results.meta.fields;
      renderCheckboxes();
      renderTable(originalData);
    }
  });
});

// Render column checkboxes
function renderCheckboxes() {
  checkboxesDiv.innerHTML = '';
  headers.forEach(header => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" checked value="${header}"> ${header}`;
    checkboxesDiv.appendChild(label);
  });

  checkboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', updateTable);
  });
}

// Update table with grouping and sorting
function updateTable() {
  const selectedColumns = Array.from(checkboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                               .map(cb => cb.value);

  if (selectedColumns.length === 0) {
    csvTable.innerHTML = '<tr><td>No columns selected</td></tr>';
    return;
  }

  // Group by selected columns (add count)
  const groupedData = {};
  originalData.forEach(row => {
    const key = selectedColumns.map(col => row[col] || '').join('|');
    if (!groupedData[key]) groupedData[key] = { ...row, count: 0 };
    groupedData[key].count += 1;
  });
  let displayData = Object.values(groupedData);

  // Apply multi-level sort
  if (sortPriority.length > 0) {
    displayData.sort((a,b) => {
      for (let s of sortPriority) {
        const valA = a[s.col] ?? '';
        const valB = b[s.col] ?? '';
        if (valA < valB) return s.dir === 'asc' ? -1 : 1;
        if (valA > valB) return s.dir === 'asc' ? 1 : -1;
      }
      return 0;
    });
  }

  renderTable(displayData, selectedColumns.concat(['count']));
  renderSortInstructions();
}

// Render table
function renderTable(data, displayColumns) {
  csvTable.innerHTML = '';
  if (data.length === 0) {
    csvTable.innerHTML = '<tr><td>No data</td></tr>';
    return;
  }

  // Table header
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  displayColumns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    if (col !== 'count') {
      th.classList.add('sortable');
      th.addEventListener('click', () => toggleSort(col));
    }
    // Add sort indicator if exists
    const sp = sortPriority.findIndex(s => s.col === col);
    if (sp >= 0) {
      const indicator = document.createElement('span');
      indicator.classList.add('sort-indicator');
      indicator.textContent = sp + 1;
      th.appendChild(indicator);
    }
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  csvTable.appendChild(thead);

  // Table body
  const tbody = document.createElement('tbody');
  data.forEach(row => {
    const tr = document.createElement('tr');
    displayColumns.forEach(col => {
      const td = document.createElement('td');
      td.textContent = row[col] ?? '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  csvTable.appendChild(tbody);
}

// Toggle sorting of a column
function toggleSort(col) {
  const existing = sortPriority.find(s => s.col === col);
  if (!existing) {
    if (sortPriority.length >= 3) sortPriority.pop(); // max 3 levels
    sortPriority.unshift({col, dir: 'asc'}); // new sort becomes first
  } else {
    existing.dir = existing.dir === 'asc' ? 'desc' : 'asc'; // toggle direction
  }
  updateTable();
}

// Display current sort instructions
function renderSortInstructions() {
  if (sortPriority.length === 0) {
    sortInstructionsDiv.innerHTML = '';
    return;
  }
  sortInstructionsDiv.innerHTML = 'Sort priority (click headers to toggle A-Z / Z-A): ' +
    sortPriority.map((s,i) => `${i+1}: ${s.col} (${s.dir.toUpperCase()})`).join(' | ');
}

// Initial render
updateTable();
</script>

</body>
</html>
